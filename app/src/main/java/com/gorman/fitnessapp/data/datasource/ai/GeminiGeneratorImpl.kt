package com.gorman.fitnessapp.data.datasource.ai

import android.util.Log
import com.gorman.fitnessapp.domain.models.UsersData
import javax.inject.Inject

class GeminiGeneratorImpl @Inject constructor(
    private val apiClient: AiApiClient
): GeminiGenerator {
    override suspend fun generateWorkoutProgram(
        userData: UsersData,
        num: Int,
        availableExercises: Map<Int?, String>
    ): String {
        val exerciseList = availableExercises.entries.joinToString(separator = ", ") {
            "${it.key}: ${it.value}"
        }
        Log.d("ExercisesAI", exerciseList)

        val prompt = """
            Ты — опытный фитнес-тренер, специализирующийся на составлении программ тренировок. 
            Твоя задача — сгенерировать $num уникальные, детализированные программы тренировок 
            на 4 недели для нового пользователя, основываясь на его данных. 
            
            --- ДАННЫЕ ПОЛЬЗОВАТЕЛЯ ---
            - Основная цель: ${userData.goal}
            - Уровень опыта: ${userData.experienceLevel}
            - Вес: ${userData.weight} кг
            - Желаемый вес: ${userData.desiredWeight} кг
            - Уровень активности: ${userData.activityLevel}
            - Тренировочные дни: 3 дня в неделю (например, ПН, СР, ПТ).
            
            --- ИНСТРУКЦИИ ---
            1. Каждая программа должна иметь уникальную фокусировку (например, "Базовая сила", "Гибрид", "Выносливость").
            2. Используй группы мышц из этого Map {1 - Грудь, 2 - Плечи, 3 - Трицепс, 4 - Ягодицы, 5 - Поясница, 6 - Верх спины, 7 - Бицепс бедра, 8 - Сгибатели бедра, 9 - Широчайшие мышцы спины, 10 - Бицепс, 11 - Предплечья, 12 - Кор, 13 - Квадрицепсы, 14 - Икроножные мышцы, 15 - Прямая мышца живота, 16 - Поперечная мышца живота, 17 - Косые мышцы живота.}
            3. Сгенерируй последовательность упражнений для каждого тренировочного дня (ПН, СР, ПТ).
            4. Используй числовые ID для упражнений (например 1, 2) СТРОГО из предоставленного списка.
            5. Поле goalType должно соответствовать цели пользователя (например, 'mass_gain').
            6. Разделяй упражнения по группам мышц: для каждого дня отдельная группа.
            7. Используй упражнения СТРОГО из этого списка: $exerciseList.
            8. Определяй durationSec каждого упражнения по средним затратам времени.
            9. Спасибо!
            
            --- ФОРМАТ ВЫВОДА (ВАЖНО!) ---
            Твой ответ должен быть **только** в формате JSON, соответствующем предоставленной схеме: $JSON_SCHEMA. 
            Помни про то что все поля схемы должны существовать в ответе.
            Ответ обязательно обрамляй [] квадратными скобками, как массив, независимо от количества объектов
            Не добавляй пояснений, приветствий или дополнительного текста.
        """

        val rawResponse = apiClient.completion(prompt)
        Log.d("rawResponse", rawResponse)
        return rawResponse
    }

    override suspend fun generateMealPlan(
        userData: UsersData,
        goal: String,
        availableMeals: Map<Int?, String>,
        exceptionProducts: List<String>
    ): String {
        val mealsList = availableMeals.entries.joinToString(separator = ", ") {
            "${it.key}: ${it.value}"
        }
        val prompt = """
                        Ты — опытный диетолог-нутрициолог, специализирующийся на создании персонализированных планов питания.
                        Твоя задача — сгенерировать детализированный и сбалансированный план питания на 7 дней для пользователя, основываясь на его данных и доступных блюдах.
                    
                        --- ДАННЫЕ ПОЛЬЗОВАТЕЛЯ ---
                        - Основная цель: ${userData.goal}
                        - Текущий вес: ${userData.weight} кг
                        - Желаемый вес: ${userData.desiredWeight} кг
                        - Рост: ${userData.height} см
                        - Пол: ${userData.gender}
                        - Уровень активности: ${userData.activityLevel}
                        - Продукты-исключения (аллергии, непереносимости): $exceptionProducts
                    
                        --- ДОСТУПНЫЕ БЛЮДА (ИСПОЛЬЗУЙ СТРОГО ЭТОТ СПИСОК) ---
                        - Карта доступных блюд: $mealsList
                    
                        --- ИНСТРУКЦИИ ---
                        1.  Проанализируй данные пользователя, чтобы определить его примерную суточную потребность в калориях и макронутриентах (БЖУ) для достижения цели (${userData.goal}).
                        2.  Составь план питания на 7 дней (Понедельник - Воскресенье).
                        3.  Для каждого дня запланируй 3-4 приема пищи (например, Завтрак, Обед, Ужин, Перекус).
                        4.  Используй числовые ID для блюд СТРОГО из предоставленной карты ${availableMeals}. Не придумывай новые блюда.
                        5.  СТРОГО исключи из плана любые блюда, которые могут содержать продукты из списка ${exceptionProducts}. Внимательно проанализируй состав блюд, исходя из их названий.
                        6.  Постарайся сделать рацион разнообразным и сбалансированным в течение недели.
                        7.  Поле 'goalType' в итоговом JSON должно соответствовать цели пользователя (например, 'weight_loss', 'muscle_gain', 'maintenance').
                        8.  Спасибо!
                    
                        --- ФОРМАТ ВЫВОДА (ВАЖНО!) ---
                        Твой ответ должен быть **только** в формате JSON и полностью соответствовать предоставленной схеме: $MEALS_JSON_SCHEMA.
                        Не добавляй никаких пояснений, приветствий или другого текста вне структуры JSON.
                    """
        val rawResponse = apiClient.completion(prompt)
        return rawResponse
    }

}